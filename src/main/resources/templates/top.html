<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
	<meta charset="UTF-8">
	<title>トップページ</title>
	<meta name="_csrf" th:content="${_csrf.token}">
	<meta name="_csrf_parameter" th:content="${_csrf.parameterName}">
	<meta name="_csrf_header" th:content="${_csrf.headerName}">
	<link th:href="@{/css/top.css}" rel="stylesheet" href="top.css">
	<link th:href="@{/css/header.css}" rel="stylesheet" href="header.css">

	<link rel="stylesheet" th:href="@{/css/footer.css}">
	<script th:src="@{/js/cart-badge.js}" src="/js/cart-badge.js" defer></script>
	<script th:src="@{/js/top.js}" src="/js/top.js" defer></script>

</head>

<body>
	<div th:replace="~{header :: header}"></div>
	<div sec:authorize="isAuthenticated()">ログインユーザー: <span sec:authentication="name">unknown</span>
	</div>
	<div sec:authorize="isAnonymous()">未ログイン</div>

	<!-- 検索 -->
	<div class="top-actions">
		<div class="actions-inner">
			<div class="search-box">
				<form th:action="@{/}" method="get" th:object="${form}">
					<input type="text" th:field="*{keyword}" placeholder="すべてのカテゴリーから検索">
					<button>検索</button>
				</form>
			</div>

			<!-- カテゴリ選択 -->
			<div class="category-filter" style="margin:8px 0;">

				<select id="categorySelect">
					<option value="">すべてのカテゴリー</option>
				</select>
			</div>

			<!-- カートへ進むボタン -->
			<a class="go-cart-btn" th:href="@{/cart}">カート詳細へ</a>
			<div id="messageArea" class="muted" th:if="${noResultMessage != null}" th:text="${noResultMessage}"></div>
			<!-- “該当する商品がありません。” の表示 -->
			<div class="muted" th:if="${noResultMessage != null}" th:text="${noResultMessage}"></div>
			<!-- 商品一覧 -->
			<h2 class="section-title">おすすめアイテム</h2>

			<div id="productGrid" class="product-grid" th:if="${products != null and #lists.size(products) > 0}">

				<article class="product-card" th:each="item : ${products}">
					<!-- 商品詳細ページへのリンク -->
					<a class="product-thumb" th:href="@{/products/{id}(id=${item['product_id']})}">
						<!-- 画像URLを th:src にセット（Mapキーはブラケット記法が安全） -->
						<img th:src="@{/images/products/{fn}(fn=${item['product_image']})}"
							th:alt="${item['product_name']}" loading="lazy">
					</a>

					<!-- 商品名 -->
					<h3 class="name" th:text="${item.product_name}">商品名</h3>

					<!-- 価格 -->
					<div class="price-area">

						<!-- 旧価格（値引き >0 の時だけ表示） -->
						<span class="price-old" th:if="${item.product_discount_price > 0}"
							th:text="${#numbers.formatInteger(item.product_price, 3, 'COMMA')} + ' 円'"></span>
						<!-- 現在価格 -->
						<span class="price-now"
							th:text="${#numbers.formatInteger(item.product_price - item.product_discount_price, 3, 'COMMA')} + ' 円'"></span>
					</div>

					<!-- カートへ追加 -->
					<form th:action="@{/cart/add}" method="post">
						<input type="hidden" name="productId" th:value="${item['product_id']}">
						<input type="hidden" name="qty" value="1">
						<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
						<!-- 未追加（cartProductIds が無い場合も未追加扱い） -->

						<button type="submit" class="js-add-to-cart-btn"
							th:if="${cartProductIds == null or !cartProductIds.contains(item['product_id'])}"
							th:attr="data-product-id=${item['product_id']}">
							カートに追加
						</button>


						<!-- 追加済み -->

						<button type="button" class="js-add-to-cart-btn is-added" disabled
							th:if="${cartProductIds != null and cartProductIds.contains(item['product_id'])}"
							th:attr="data-product-id=${item['product_id']}">
							カート追加済み
						</button>

					</form>
				</article>
			</div>
		</div>
	</div>
	<div th:replace="~{footer :: footer}"></div>
</body>

</html>